<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人技术小屋，点滴积累"><title>RabbitMQ 延时队列 | 技术小屋</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-146373511-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '6e30653711aac2cc552b0ecb94df5e77';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script data-ad-client="ca-pub-2920624860740745" async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.0.2"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">RabbitMQ 延时队列</h1><a id="logo" href="/.">技术小屋</a><p class="description">积水成渊、 积土成山</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/guestbook/"><i class="fa fa-book"> 留言</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">RabbitMQ 延时队列</h1><div class="post-meta">2020-09-16<span> | </span><span class="category"><a href="/categories/Java/">Java</a></span></div><div class="post-content"><p>​    上一章介绍了<code>RabbitMQ</code>中死信队列的使用，接下来介绍RabbitMQ中延时队列的使用，<strong>包括队列TTL，消息TTL和RabbitMQ延迟插件。</strong></p>
<p><img src="/post/java/20200916/timer.png"></p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>延时队列在需要延时处理的场景下非常有用，队列中的元素都是带有时间属性的， <strong>普通队列的元素按照队列的次序依次取出处理；延时队列中的元素则按照指定时间被取出和处理。</strong> </p>
<ul>
<li>订单10分钟内未支付则自动取消。</li>
<li>店铺10天没有更新，发消息提醒。</li>
<li>账单一周内未支付，自动支付。</li>
<li>新用户注册3天内没登录，短信提醒。</li>
<li>预约会议后，在预定的时间开始前15分钟通知参会人员。</li>
<li>发送定时消息。</li>
</ul>
<p>这些场景都有一个共同点，就是跟时间有关。理想情况下，通过定时任务轮询数据可以实现功能；但随着数据量的增加，轮询会带来巨大的性能问题，同时轮询的方式处理起来很不优雅。这时候延时队列就派上用场了。</p>
<h3 id="RabbitMQ中的TTL"><a href="#RabbitMQ中的TTL" class="headerlink" title="RabbitMQ中的TTL"></a>RabbitMQ中的TTL</h3><p><strong>TTL是RabbitMQ中一个消息或者队列的属性，表明一条消息或者队列中的所有消息的最大存活时间（毫秒）</strong>。<br>即如果一条消息设置了TTL，或者进入了设置TTL属性的队列，那么这条消息如果在TTL时限内未被消费，则会成为死信；如果两者同时设置了TTL，那么较小TTL会被使用。</p>
<p><strong>在消息属性上设置TTL的方式，消息可能并不会按时“死亡“，RabbitMQ只会检查第一个消息是否过期，如果过期则丢到死信队列，索引如果第一个消息的延时时长很长，而第二个消息的延时时长很短，则第二个消息并不会优先得到执行。</strong></p>
<p>队列TTL的设置，实在创建队列的时候，设置队列的<code>x-message-ttl</code>属性，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; args = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">60000</span>);<span class="comment">//设置60秒ttl</span></span><br><span class="line"><span class="keyword">return</span> QueueBuilder.durable(QUEUE_DELAY_FIX_NAME).withArguments(args).build();</span><br></pre></td></tr></table></figure>


<h3 id="队列TTL-死信队列"><a href="#队列TTL-死信队列" class="headerlink" title="队列TTL + 死信队列"></a>队列TTL + 死信队列</h3><p>通过给队列配置TTL，配合死信队列来实现消息的延时。<strong>因为队列的TTL固定，所以这种如果有新的时间需求，则需要增加队列。</strong> 这种适用于固定延时时间的场景。</p>
<h4 id="配置队列"><a href="#配置队列" class="headerlink" title="配置队列"></a>配置队列</h4><p>声明常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQConstant</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Exchange 交换器/</span></span><br><span class="line"><span class="comment">    public static final String EXCHANGE_DELAY_FIX_NAME = &quot;exchange.demo.fix.delay&quot;;</span></span><br><span class="line"><span class="comment">    public static final String EXCHANGE_DEAD_NAME = &quot;exchange.demo.dead&quot;;</span></span><br><span class="line"><span class="comment">    / 路由定义 /</span></span><br><span class="line"><span class="comment">    public static final String ROUTING_KEY_DELAY_FIX_1_NAME = &quot;routingkey.demo.fix.1.delay&quot;;</span></span><br><span class="line"><span class="comment">    public static final String ROUTING_KEY_DEAD_NAME = &quot;routingkey.demo.dead&quot;;</span></span><br><span class="line"><span class="comment">    / 队列定义 **/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_DELAY_FIX_1_NAME = <span class="string">&quot;queue.demo.fix.1.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_DEAD_NAME = <span class="string">&quot;queue.demo.dead&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>队列路由与交换器绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.liangtong.example.rabbit.constant.MQConstant.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明交换器</span></span><br><span class="line">    <span class="meta">@Bean(&quot;fixDelayExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">fixDelayExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(EXCHANGE_DELAY_FIX_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean(&quot;deadExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">deadExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(EXCHANGE_DEAD_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;fixDelayQueue1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">fixDelayQueue1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">//绑定死信队列</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, EXCHANGE_DEAD_NAME);</span><br><span class="line">        <span class="comment">//当前队列的死信路由Key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, ROUTING_KEY_DEAD_NAME);</span><br><span class="line">        <span class="comment">// x-message-ttl  声明队列的TTL</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">60000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_DELAY_FIX_1_NAME).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean(&quot;deadQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">deadQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(QUEUE_DEAD_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定关系</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">fixDelay1Binding</span><span class="params">(<span class="meta">@Qualifier(&quot;fixDelayQueue1&quot;)</span> Queue queue,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   <span class="meta">@Qualifier(&quot;fixDelayExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue)</span><br><span class="line">                .to(exchange)</span><br><span class="line">                .with(ROUTING_KEY_DELAY_FIX_1_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">deadBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;deadQueue&quot;)</span> Queue queue,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="meta">@Qualifier(&quot;deadExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue)</span><br><span class="line">                .to(exchange)</span><br><span class="line">                .with(ROUTING_KEY_DEAD_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="死信消费者"><a href="#死信消费者" class="headerlink" title="死信消费者"></a>死信消费者</h4><p>此处不再配置延时消费者，而是例如TTL过期直接进消费队列机制，仅配置死信消息消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadConsumer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = QUEUE_DEAD_NAME)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveDead</span><span class="params">(Message message,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;收到死信消息: &quot;</span> + message);</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消息生产者"><a href="#消息生产者" class="headerlink" title="消息生产者"></a>消息生产者</h4><p>消息生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MsgProducer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendFixDelayMsg1</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;发送延时消息：&#123;&#125;&quot;</span>, msg);</span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_DELAY_FIX_NAME,</span><br><span class="line">                ROUTING_KEY_DELAY_FIX_1_NAME,</span><br><span class="line">                msg,</span><br><span class="line">                <span class="keyword">new</span> CorrelationData()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>创建Webcontroller来进行功能测试，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;rabbitmq&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMsgController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MsgProducer sender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;fixDelay1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendFixDelay1Msg</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        sender.sendFixDelayMsg1(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动SpringBoot项目，然后浏览器输入<code>http://localhost:8081/rabbitmq/fixDelay1?msg=Hello</code>和<code>http://localhost:8081/rabbitmq/fixDelay1?msg=梁通</code>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2020-09-16 12:45:59.686  INFO 84248 --- [nio-8081-exec-5] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：Hello </span><br><span class="line">2020-09-16 12:46:02.521  INFO 84248 --- [nio-8081-exec-6] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：梁通 </span><br><span class="line">2020-09-16 12:46:59.690  INFO 84248 --- [ntContainer<span class="comment">#0-5] o.l.e.rabbit.consumer.DeadConsumer       : 收到死信消息: (Body:&#x27;Hello&#x27; MessageProperties [headers=&#123;x-first-death-exchange=exchange.demo.fix.delay, x-death=[&#123;reason=expired, count=1, exchange=exchange.demo.fix.delay, time=Wed Sep 16 12:46:59 CST 2020, routing-keys=[queue.demo.fix.delay], queue=queue.demo.fix.delay&#125;], x-first-death-reason=expired, x-first-death-queue=queue.demo.fix.delay&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.dead, receivedRoutingKey=routingkey.demo.dead, deliveryTag=1, consumerTag=amq.ctag-V5GgFrP46_kt4CxtQXt9_w, consumerQueue=queue.demo.dead])</span></span><br><span class="line">2020-09-16 12:47:02.524  INFO 84248 --- [ntContainer<span class="comment">#0-6] o.l.e.rabbit.consumer.DeadConsumer       : 收到死信消息: (Body:&#x27;梁通&#x27; MessageProperties [headers=&#123;x-first-death-exchange=exchange.demo.fix.delay, x-death=[&#123;reason=expired, count=1, exchange=exchange.demo.fix.delay, time=Wed Sep 16 12:47:02 CST 2020, routing-keys=[queue.demo.fix.delay], queue=queue.demo.fix.delay&#125;], x-first-death-reason=expired, x-first-death-queue=queue.demo.fix.delay&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.dead, receivedRoutingKey=routingkey.demo.dead, deliveryTag=1, consumerTag=amq.ctag-dd6HVYjD0xs7voSVu2o-tg, consumerQueue=queue.demo.dead])</span></span><br></pre></td></tr></table></figure>
<p>可以看到，消息在经过60秒后，被消费掉。</p>
<h3 id="消息TTL-死信队列"><a href="#消息TTL-死信队列" class="headerlink" title="消息TTL + 死信队列"></a>消息TTL + 死信队列</h3><p>在队列上设置TTL时，延时时间固定。还有一种方案，就是设置任意延时时长的消息，然后设置消息的TTL。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQConstant</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** Exchange 交换器/</span></span><br><span class="line"><span class="comment">    public static final String EXCHANGE_DELAY_FIX_NAME = &quot;exchange.demo.fix.delay&quot;;</span></span><br><span class="line"><span class="comment">    public static final String EXCHANGE_DEAD_NAME = &quot;exchange.demo.dead&quot;;</span></span><br><span class="line"><span class="comment">    / 路由定义 /</span></span><br><span class="line"><span class="comment">    public static final String ROUTING_KEY_DELAY_FIX_1_NAME = &quot;routingkey.demo.fix.1.delay&quot;;</span></span><br><span class="line"><span class="comment">    public static final String ROUTING_KEY_DELAY_FIX_2_NAME = &quot;routingkey.demo.fix.2.delay&quot;;</span></span><br><span class="line"><span class="comment">    public static final String ROUTING_KEY_DEAD_NAME = &quot;routingkey.demo.dead&quot;;</span></span><br><span class="line"><span class="comment">    / 队列定义 **/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_DELAY_FIX_1_NAME = <span class="string">&quot;queue.demo.fix.1.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_DELAY_FIX_2_NAME = <span class="string">&quot;queue.demo.fix.2.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_DEAD_NAME = <span class="string">&quot;queue.demo.dead&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="队列配置"><a href="#队列配置" class="headerlink" title="队列配置"></a>队列配置</h4><p>不设置队列TTL相关代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明队列</span></span><br><span class="line"><span class="meta">@Bean(&quot;fixDelayQueue2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Queue <span class="title">fixDelayQueue2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; args = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">//绑定死信队列</span></span><br><span class="line">    args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, EXCHANGE_DEAD_NAME);</span><br><span class="line">    <span class="comment">//当前队列的死信路由Key</span></span><br><span class="line">    args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, ROUTING_KEY_DEAD_NAME);</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder.durable(QUEUE_DELAY_FIX_2_NAME).withArguments(args).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定关系</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Binding <span class="title">fixDelay2Binding</span><span class="params">(<span class="meta">@Qualifier(&quot;fixDelayQueue2&quot;)</span> Queue queue,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="meta">@Qualifier(&quot;fixDelayExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue)</span><br><span class="line">            .to(exchange)</span><br><span class="line">            .with(ROUTING_KEY_DELAY_FIX_2_NAME);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消息生产者-1"><a href="#消息生产者-1" class="headerlink" title="消息生产者"></a>消息生产者</h4><p>设置消息过期时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendFixDelayMsg2</span><span class="params">(String msg, Integer delay)</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;发送延时消息：&#123;&#125; 延时&#123;&#125;秒&quot;</span>, msg, delay);</span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_DELAY_FIX_NAME,</span><br><span class="line">            ROUTING_KEY_DELAY_FIX_2_NAME,</span><br><span class="line">            msg,</span><br><span class="line">            message -&gt; &#123;</span><br><span class="line">                message.getMessageProperties().setExpiration(String.valueOf(delay * <span class="number">1000</span>) );</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;fixDelay2&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendFixDelay2Msg</span><span class="params">(String msg, Integer delay)</span></span>&#123;</span><br><span class="line">    sender.sendFixDelayMsg2(msg, delay);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动SpringBoot项目，然后浏览器输入<code>http://localhost:8081/rabbitmq/fixDelay2?测试10&amp;delay=10</code>和<code>http://localhost:8081/rabbitmq/fixDelay2?测试20&amp;delay=20</code>和<code>http://localhost:8081/rabbitmq/fixDelay2?测试30&amp;delay=30</code>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2020-09-16 13:38:13.371  INFO 94573 --- [nio-8081-exec-5] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：测试10 延时10秒</span><br><span class="line">2020-09-16 13:38:18.863  INFO 94573 --- [nio-8081-exec-6] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：测试20 延时20秒</span><br><span class="line">2020-09-16 13:38:23.374  INFO 94573 --- [ntContainer<span class="comment">#0-3] o.l.e.rabbit.consumer.DeadConsumer       : 收到死信消息: (Body:&#x27;测试10&#x27; MessageProperties [headers=&#123;x-first-death-exchange=exchange.demo.fix.delay, x-death=[&#123;reason=expired, original-expiration=10000, count=1, exchange=exchange.demo.fix.delay, time=Wed Sep 16 13:38:23 CST 2020, routing-keys=[routingkey.demo.fix.2.delay], queue=queue.demo.fix.2.delay&#125;], x-first-death-reason=expired, x-first-death-queue=queue.demo.fix.2.delay&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.dead, receivedRoutingKey=routingkey.demo.dead, deliveryTag=1, consumerTag=amq.ctag-xFbTWO_LXJEYVM52clOHjQ, consumerQueue=queue.demo.dead])</span></span><br><span class="line">2020-09-16 13:38:24.206  INFO 94573 --- [nio-8081-exec-7] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：测试30 延时30秒</span><br><span class="line">2020-09-16 13:38:24.379  INFO 94573 --- [ntContainer<span class="comment">#0-3] o.s.a.r.l.SimpleMessageListenerContainer : Restarting Consumer@162a6c67: tags=[[amq.ctag-xFbTWO_LXJEYVM52clOHjQ]], channel=Cached Rabbit Channel: AMQChannel(amqp://liangtong@127.0.0.1:5672/,2), conn: Proxy@1e95b653 Shared Rabbit Connection: SimpleConnection@6d8796c1 [delegate=amqp://liangtong@127.0.0.1:5672/, localPort= 56297], acknowledgeMode=AUTO local queue size=0</span></span><br><span class="line">2020-09-16 13:38:38.866  INFO 94573 --- [ntContainer<span class="comment">#0-4] o.l.e.rabbit.consumer.DeadConsumer       : 收到死信消息: (Body:&#x27;测试20&#x27; MessageProperties [headers=&#123;x-first-death-exchange=exchange.demo.fix.delay, x-death=[&#123;reason=expired, original-expiration=20000, count=1, exchange=exchange.demo.fix.delay, time=Wed Sep 16 13:38:38 CST 2020, routing-keys=[routingkey.demo.fix.2.delay], queue=queue.demo.fix.2.delay&#125;], x-first-death-reason=expired, x-first-death-queue=queue.demo.fix.2.delay&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.dead, receivedRoutingKey=routingkey.demo.dead, deliveryTag=1, consumerTag=amq.ctag-yGbXcSqjA7G5NbSU90ScoQ, consumerQueue=queue.demo.dead])</span></span><br><span class="line">2020-09-16 13:38:39.870  INFO 94573 --- [ntContainer<span class="comment">#0-4] o.s.a.r.l.SimpleMessageListenerContainer : Restarting Consumer@7571d97c: tags=[[amq.ctag-yGbXcSqjA7G5NbSU90ScoQ]], channel=Cached Rabbit Channel: AMQChannel(amqp://liangtong@127.0.0.1:5672/,3), conn: Proxy@1e95b653 Shared Rabbit Connection: SimpleConnection@6d8796c1 [delegate=amqp://liangtong@127.0.0.1:5672/, localPort= 56297], acknowledgeMode=AUTO local queue size=0</span></span><br><span class="line">2020-09-16 13:38:54.209  INFO 94573 --- [ntContainer<span class="comment">#0-5] o.l.e.rabbit.consumer.DeadConsumer       : 收到死信消息: (Body:&#x27;测试30&#x27; MessageProperties [headers=&#123;x-first-death-exchange=exchange.demo.fix.delay, x-death=[&#123;reason=expired, original-expiration=30000, count=1, exchange=exchange.demo.fix.delay, time=Wed Sep 16 13:38:54 CST 2020, routing-keys=[routingkey.demo.fix.2.delay], queue=queue.demo.fix.2.delay&#125;], x-first-death-reason=expired, x-first-death-queue=queue.demo.fix.2.delay&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.dead, receivedRoutingKey=routingkey.demo.dead, deliveryTag=1, consumerTag=amq.ctag-1K-YeHnNpqh6utswjyXIuQ, consumerQueue=queue.demo.dead])</span></span><br><span class="line">2020-09-16 13:38:55.211  INFO 94573 --- [ntContainer<span class="comment">#0-5] o.s.a.r.l.SimpleMessageListenerContainer : Restarting Consumer@340b6985: tags=[[amq.ctag-1K-YeHnNpqh6utswjyXIuQ]], channel=Cached Rabbit Channel: AMQChannel(amqp://liangtong@127.0.0.1:5672/,3), conn: Proxy@1e95b653 Shared Rabbit Connection: SimpleConnection@6d8796c1 [delegate=amqp://liangtong@127.0.0.1:5672/, localPort= 56297], acknowledgeMode=AUTO local queue size=0</span></span><br></pre></td></tr></table></figure>

<p>可以看到，发送的消息，再经过特定的ttl时间后，被消费掉。</p>
<p>别高兴太早，前边介绍过，在消息上添加TTL时，消息可能不会按时消亡。RabbitMQ只会检查第一个消息是否过期，如果过期则丢到死信队列，索引如果第一个消息的延时时长很长，而第二个消息的延时时长很短，则第二个消息并不会优先得到执行。然后我们测试下：</p>
<p>浏览器输入<code>http://localhost:8081/rabbitmq/fixDelay2?测试30&amp;delay=30</code>和<code>http://localhost:8081/rabbitmq/fixDelay2?测试10&amp;delay=10</code>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2020-09-16 13:44:35.203  INFO 94573 --- [io-8081-exec-10] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：测试30 延时30秒</span><br><span class="line">2020-09-16 13:44:39.832  INFO 94573 --- [nio-8081-exec-1] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：测试10 延时10秒</span><br><span class="line">2020-09-16 13:45:05.206  INFO 94573 --- [ntContainer<span class="comment">#0-6] o.l.e.rabbit.consumer.DeadConsumer       : 收到死信消息: (Body:&#x27;测试30&#x27; MessageProperties [headers=&#123;x-first-death-exchange=exchange.demo.fix.delay, x-death=[&#123;reason=expired, original-expiration=30000, count=1, exchange=exchange.demo.fix.delay, time=Wed Sep 16 13:45:05 CST 2020, routing-keys=[routingkey.demo.fix.2.delay], queue=queue.demo.fix.2.delay&#125;], x-first-death-reason=expired, x-first-death-queue=queue.demo.fix.2.delay&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.dead, receivedRoutingKey=routingkey.demo.dead, deliveryTag=1, consumerTag=amq.ctag-ZbAeduIZW8Pd_RBTcZPDsg, consumerQueue=queue.demo.dead])</span></span><br><span class="line">2020-09-16 13:45:05.207  INFO 94573 --- [ntContainer<span class="comment">#0-6] o.l.e.rabbit.consumer.DeadConsumer       : 收到死信消息: (Body:&#x27;测试10&#x27; MessageProperties [headers=&#123;x-first-death-exchange=exchange.demo.fix.delay, x-death=[&#123;reason=expired, original-expiration=10000, count=1, exchange=exchange.demo.fix.delay, time=Wed Sep 16 13:45:05 CST 2020, routing-keys=[routingkey.demo.fix.2.delay], queue=queue.demo.fix.2.delay&#125;], x-first-death-reason=expired, x-first-death-queue=queue.demo.fix.2.delay&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.dead, receivedRoutingKey=routingkey.demo.dead, deliveryTag=2, consumerTag=amq.ctag-ZbAeduIZW8Pd_RBTcZPDsg, consumerQueue=queue.demo.dead])</span></span><br></pre></td></tr></table></figure>
<p>结果显示，即使第二条消息的TTL较短（10秒），消息在第一条消息成为死信后才被消费。（<strong>惊不惊喜，意不意外！</strong>）</p>
<h3 id="延时插件"><a href="#延时插件" class="headerlink" title="延时插件"></a>延时插件</h3><p>从上边测试可以看出，RabbitMQ在消息粒度上的延迟无法满足个性化的延时需求。那么这种消息粒度上的延时问题如何解决呢。<br>接下来介绍通过安装RabbitMQ插件的形式来完美解决。<br>插件下载地址：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a></p>
<p><img src="/post/java/20200916/rabbit_delay_message_exchange.png" alt="rabbit_delay_message_exchange.png"></p>
<p>这里，我们需要找到 <code>rabbitmq_delayed_message_exchange</code> 插件，下载后，将<code>rabbitmq_delayed_message_exchange-3.8.0.ez</code>文件放到<code>sbin</code>同级的<code>plugins</code>目录下，然后切换到<code>sbin</code>目录，安装插件并重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ./rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_delayed_message_exchange</span><br><span class="line">&gt; ./rabbitmqctl stop</span><br><span class="line">&gt; ./rabbitmq-server</span><br></pre></td></tr></table></figure>

<p><img src="/post/java/20200916/rabbitctl_restart.png" alt="rabbitctl_restart.png"></p>
<h4 id="配置队列-1"><a href="#配置队列-1" class="headerlink" title="配置队列"></a>配置队列</h4><p>设置常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQConstant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Exchange 交换器**/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_DELAY_NAME = <span class="string">&quot;exchange.demo.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_DEAD_NAME = <span class="string">&quot;exchange.demo.dead&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 路由定义 **/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY_DELAY_NAME = <span class="string">&quot;routingkey.demo.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY_DEAD_NAME = <span class="string">&quot;routingkey.demo.dead&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 队列定义 **/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_DELAY_NAME = <span class="string">&quot;queue.demo.delay&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_DEAD_NAME = <span class="string">&quot;queue.demo.dead&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>队列路由与交换器绑定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明交换器</span></span><br><span class="line">    <span class="meta">@Bean(&quot;delayExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CustomExchange <span class="title">delayExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        args.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CustomExchange(EXCHANGE_DELAY_NAME, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;deadExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">deadExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(EXCHANGE_DEAD_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 声明队列</span></span><br><span class="line">    <span class="meta">@Bean(&quot;delayQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">delayQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//绑定死信队列</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, EXCHANGE_DEAD_NAME);</span><br><span class="line">        <span class="comment">//当前队列的死信路由Key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, ROUTING_KEY_DEAD_NAME);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(QUEUE_DELAY_NAME).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;deadQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">deadQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(QUEUE_DEAD_NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定关系</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">delayBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;delayQueue&quot;)</span> Queue queue,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="meta">@Qualifier(&quot;delayExchange&quot;)</span> CustomExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue)</span><br><span class="line">                .to(exchange)</span><br><span class="line">                .with(ROUTING_KEY_DELAY_NAME).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">deadBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;deadQueue&quot;)</span> Queue queue,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="meta">@Qualifier(&quot;deadExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue)</span><br><span class="line">                .to(exchange)</span><br><span class="line">                .with(ROUTING_KEY_DEAD_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h4><p>死信消费者不变，此处增加延时队列消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = QUEUE_DELAY_NAME)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveDelay</span><span class="params">(Message message,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;收到延时消息: &quot;</span> + message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> ack = <span class="keyword">true</span>;</span><br><span class="line">        Exception exception = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//处理延时消息</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ack = <span class="keyword">false</span>;</span><br><span class="line">            exception = e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!ack) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;消息消费发生异常，error msg:&#123;&#125;&quot;</span>, exception.getMessage(), exception);</span><br><span class="line">            channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h4><p>生产者设置延时时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delayMsg</span><span class="params">(String msg, Integer delay)</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;发送延时消息：&#123;&#125; 延时&#123;&#125;秒&quot;</span>, msg, delay);</span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_DELAY_NAME,</span><br><span class="line">            ROUTING_KEY_DELAY_NAME,</span><br><span class="line">            msg,</span><br><span class="line">            message -&gt; &#123;</span><br><span class="line">                message.getMessageProperties().setDelay(delay * <span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试代码-1"><a href="#测试代码-1" class="headerlink" title="测试代码"></a>测试代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;delay&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendDelay</span><span class="params">(String msg, Integer delay)</span></span>&#123;</span><br><span class="line">    sender.delayMsg(msg, delay);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动SpringBoot项目，然后浏览器输入<code>http://localhost:8081/rabbitmq/delay?测试30&amp;delay=30</code>、<code>http://localhost:8081/rabbitmq/delay?测试20&amp;delay=20</code>、<code>http://localhost:8081/rabbitmq/delay?测试50&amp;delay=50</code>和<code>http://localhost:8081/rabbitmq/delay?测试10&amp;delay=10</code>测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2020-09-16 14:09:35.903  INFO 2955 --- [nio-8081-exec-1] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：测试30 延时30秒</span><br><span class="line">2020-09-16 14:09:43.152  INFO 2955 --- [nio-8081-exec-2] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：测试20 延时20秒</span><br><span class="line">2020-09-16 14:09:48.832  INFO 2955 --- [nio-8081-exec-3] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：测试50 延时50秒</span><br><span class="line">2020-09-16 14:09:53.086  INFO 2955 --- [nio-8081-exec-4] o.l.example.rabbit.producer.MsgProducer  : 发送延时消息：测试10 延时10秒</span><br><span class="line">2020-09-16 14:10:03.095  INFO 2955 --- [ntContainer<span class="comment">#1-1] o.l.e.rabbit.consumer.DelayConsumer      : 收到延迟推送消息: (Body:&#x27;测试10&#x27; MessageProperties [headers=&#123;&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.delay, receivedRoutingKey=routingkey.demo.delay, receivedDelay=10000, deliveryTag=1, consumerTag=amq.ctag-rvB4gUM_H9dHVWBy882mUw, consumerQueue=queue.demo.delay])</span></span><br><span class="line">2020-09-16 14:10:04.103  INFO 2955 --- [ntContainer<span class="comment">#1-2] o.l.e.rabbit.consumer.DelayConsumer      : 收到延迟推送消息: (Body:&#x27;测试20&#x27; MessageProperties [headers=&#123;&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.delay, receivedRoutingKey=routingkey.demo.delay, receivedDelay=20000, deliveryTag=1, consumerTag=amq.ctag-VU9VXQa2OT78oceGFH0xcA, consumerQueue=queue.demo.delay])</span></span><br><span class="line">2020-09-16 14:10:09.114  INFO 2955 --- [ntContainer<span class="comment">#1-3] o.l.e.rabbit.consumer.DelayConsumer      : 收到延迟推送消息: (Body:&#x27;测试30&#x27; MessageProperties [headers=&#123;&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.delay, receivedRoutingKey=routingkey.demo.delay, receivedDelay=30000, deliveryTag=1, consumerTag=amq.ctag-6bzse22_iQ8XRKBv_Elxqg, consumerQueue=queue.demo.delay])</span></span><br><span class="line">2020-09-16 14:10:38.836  INFO 2955 --- [ntContainer<span class="comment">#1-4] o.l.e.rabbit.consumer.DelayConsumer      : 收到延迟推送消息: (Body:&#x27;测试50&#x27; MessageProperties [headers=&#123;&#125;, contentType=text/plain, contentEncoding=UTF-8, contentLength=0, receivedDeliveryMode=PERSISTENT, priority=0, redelivered=false, receivedExchange=exchange.demo.delay, receivedRoutingKey=routingkey.demo.delay, receivedDelay=50000, deliveryTag=1, consumerTag=amq.ctag-W9bB-UA0fZsHu0WCGvoPDQ, consumerQueue=queue.demo.delay])</span></span><br></pre></td></tr></table></figure>
<p>可以看到，<strong>借助于RabbitMQ延迟插件，延时队列按照消息粒度进行了消费！（此处应该有掌声👏）</strong></p>
<p><strong>至此，RabbitMQ 关于普通消息、死信队列和延迟队列相关内容已结束。</strong></p>
<p>RabbitMQ相关的Demo代码已上传至Github，有需要的话可自行下载查阅。</p>
<p>地址：<a target="_blank" rel="noopener" href="https://github.com/liangtongdev/demo-springboot-rabbitmq">https://github.com/liangtongdev/demo-springboot-rabbitmq</a></p>
<p>后续：接下来将介绍利用RabbitMQ实现即时消息的消费，配合Redis实现延时发送与取消。</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>本文标题：</span>RabbitMQ 延时队列</p><p><span>文章作者：</span>梁通</p><p><span>发布时间：</span>2020-09-16</p><p><span>最后更新：</span>2020-10-23</p><p><span>原始链接：</span><a href="/2020/09/16/java_20200916_springboot_rabbitmq_delay/">http://www.liangtong.site/2020/09/16/java_20200916_springboot_rabbitmq_delay/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="http://www.liangtong.site/2020/09/16/java_20200916_springboot_rabbitmq_delay/"></i></span></p><p><span>版权声明：</span>Copyright© 2016-2020 liangtong 版权所有</p></div><br><div class="tags"><a href="/tags/mq/"><i class="fa fa-tag"></i>mq</a></div><div class="post-nav"><a class="pre" href="/2020/10/17/java_20201017_spring_@/">Spring 中 @Component和@Bean的区别</a><a class="next" href="/2020/09/16/java_20200916_springboot_rabbitmq_dead/">RabbitMQ 死信队列</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC81Mjk5OS8yOTQ3NQ"><script>(function(d, s) {
   var j, e = d.getElementsByTagName(s)[0];
   if (typeof LivereTower === 'function') { return; }
   j = d.createElement(s);
   j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
   j.async = true;
   e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.liangtong.site"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/GoLang/">GoLang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/xx%E6%98%AF%E5%A6%82%E4%BD%95xx%E7%9A%84/">xx是如何xx的</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E4%BA%AB/">分享</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E6%9E%90/">分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/">微信小程序</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%80%BB%E7%BB%93/">总结</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E6%90%9C%E7%B4%A2/" style="font-size: 15px;">搜索</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 15px;">排序</a> <a href="/tags/%E7%AE%97%E8%B7%AF/" style="font-size: 15px;">算路</a> <a href="/tags/sqlite3/" style="font-size: 15px;">sqlite3</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">笔记</a> <a href="/tags/mq/" style="font-size: 15px;">mq</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/Spring-AOP/" style="font-size: 15px;">Spring AOP</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E6%98%AF%E5%A6%82%E4%BD%95%E9%80%9A%E4%BF%A1%E7%9A%84/" style="font-size: 15px;">网络是如何通信的</a> <a href="/tags/searchBar/" style="font-size: 15px;">searchBar</a> <a href="/tags/bluetooth/" style="font-size: 15px;">bluetooth</a> <a href="/tags/objc/" style="font-size: 15px;">objc</a> <a href="/tags/gcd/" style="font-size: 15px;">gcd</a> <a href="/tags/runtime/" style="font-size: 15px;">runtime</a> <a href="/tags/tableView/" style="font-size: 15px;">tableView</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/CocoaPods/" style="font-size: 15px;">CocoaPods</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/tool/" style="font-size: 15px;">tool</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/chrome/" style="font-size: 15px;">chrome</a> <a href="/tags/objc-summary/" style="font-size: 15px;">objc-summary</a> <a href="/tags/SwiftUI/" style="font-size: 15px;">SwiftUI</a> <a href="/tags/miniprogram/" style="font-size: 15px;">miniprogram</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/09/24/objc_20210924_note_enterprise_app_crash/">iOS企业级应用ipa文件签名过期时间检查与重签名</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/31/share_20210331_centos7_docker_image_prune/">Docker 清理没有标签、并且不再被容器使用的镜像</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/04/database_20210204_mysql_master_slave/">MYSQL Master - Slave 主从复制</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/01/share_20210201_centos7_docker_ipv4_forwarding/">IPv4 forwarding is disabled. Networking will not work.</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/29/share_20210129_win10_chrome_max/">全屏浏览网页</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/16/java_20210116_spring_boot_filter_interceptor/">SpringBoot 过滤器和拦截器的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/25/database_20201025_redis_intset/">Redis数据结构 - 整数集合intset</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/24/database_20201024_redis_skiplist/">Redis数据结构 - 跳表skiplist</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/23/database_20201023_redis_dict/">Redis数据结构 - 字典</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/22/database_20201022_redis_list/">Redis数据结构 - 链表</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/liangtongdev" title="github" target="_blank">github</a><ul></ul><a href="https://www.jianshu.com/u/39237a8a7121" title="简书" target="_blank">简书</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2016-2021 成长的点滴积累 <br/><a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/"> 豫ICP备2020029597号-1</a><br/><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41010202002931" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="/img/beian.png" style="float:left;"/><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">豫公网安备 41010202002931号</p></a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>