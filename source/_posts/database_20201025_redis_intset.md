---
layout:     post
title:      Redis数据结构 - 整数集合intset
date:       2020-10-25 18:00:00
author:     liangtong
catalog: true
categories: 数据库
tags: redis
---

整数集合是集合健的底层实现之一，当一个集合中只包含整数值元素，且元素不多时，Redis就会使用整数集合作为集合健的底层实现。

![](/post/db/20201025/redis_intset.png)

### 整数集合

```C
/////编码方式
//16位，2个字节，表示范围-32,768~32,767
#define INTSET_ENC_INT16 (sizeof(int16_t))  
//32位，4个字节，表示范围-2,147,483,648~2,147,483,647
#define INTSET_ENC_INT32 (sizeof(int32_t))  
//64位，8个字节，表示范围-9,223,372,036,854,775,808~9,223,372,036,854,775,807
#define INTSET_ENC_INT64 (sizeof(int64_t))   
```



```C
//intset
typedef struct intset {
  //编码方式
  uint32_t encoding;
  //集合中包含的元素数量
  uint32_t length;
  //保存元素的数组
  int8_t contents;
} intset;
```

+ encoding ： 编码方式，默认值是 `INTSET_ENC_INT16`。 其值直接影响contents数组中元素的数据类型。

+ length：整数集合的元素数量，也就是contents数组的长度。
+ contents数组是整数集合的底层实现；数组中的元素按照从小到达的顺序排列，不包括重复项。类型由encoding值决定。



### 升级

当将一个新的元素添加到整数集合中，且新元素的类型比整数集合现有的元素类型要长时，整数集合需要先进行升级，然后才能将新元素添加到整数集合里边。

升级整数集合的步骤如下：

+ 根据新元素的类型，扩展整数集合底层数组的空间大小（包括新元素的空间）。
+ 将底层数组中的所有元素都转换成新元素相同的类型，并将转换后的元素放置到正确的位上（放置过程（从右至左）中，维持底层数组的有序性）。
+ 将新元素添加到底层数组里边（最末尾）。

**升级到好处：节约内存。**只在必要的时候升级，才会升级（比如香int16_t类型整数集合中添加int64_t类型元素时才进行升级，而不是初始情况下直接使用int64_t类型存储）。

### 降级

**整数集合不支持降级操作**，一旦对数组进行了升级，编码就一直处于升级后的状态。



### 添加元素流程

![](/post/db/20201025/redis_intset_add_flow.png)



